{
    "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
    "title": {
        "text": "Blood Donations by State in Malaysia",
        "fontSize": 30,
        "font": "Serif"
    },
    "data": {
        "url": "https://raw.githubusercontent.com/HXianH/Homework-W10/refs/heads/main/pivoted_dataset.csv",
        "format": {
            "type": "csv"
        }
    },
    "width": 1000,
    "height": 500, 
    "projection": {
        "type": "equalEarth",
        "scale": 3500,
        "center": [108, 3.8]
    },
    "params": [
        {
            "name": "year_selected",
            "value": 2019,
            "bind": {
                "input": "range",
                "min": 2019,
                "max": 2024,
                "step": 1,
                "name": "Year: "
            }
        }
    ],
    "transform": [
        {"filter": "datum.year == year_selected"}
    ],
    "layer": [
		{
			"data": {
				"graticule": {
					"step": [2, 2]
				}
			},
			"mark": {
				"type": "geoshape",
				"stroke": "#868585"
			}
		},
		{
			"data": {
				"url": "https://raw.githubusercontent.com/HXianH/Homework-W9/refs/heads/main/malaysia-states.topojson",
				"format": {
					"type": "topojson",
					"feature": "states"
				}
			},
			"transform": [
				{
					"lookup": "properties.Name",
					"from": {
						"data": {
							"url": "https://raw.githubusercontent.com/HXianH/Homework-W10/refs/heads/main/pivoted_dataset.csv",
							"format": {
								"type": "csv"
							}
						},
                        
						"key": "state",
						"fields": [
							"2019", "2020", "2021", "2022", "2023", "2024"
						]
					}
				},
				{
					"calculate": "'Data is not available in ' + datum.properties.Name",
					"as": "note"
				}
			],
			"mark": {
				"type": "geoshape",
				"fill": "lightgray",
				"stroke": "black"
			},
			"encoding": {
				"tooltip": {
					"field": "note"
				}
			}
		},
		{
			"data": {
				"url": "https://raw.githubusercontent.com/HXianH/Homework-W9/refs/heads/main/malaysia-states.topojson",
				"format": {
					"type": "topojson",
					"feature": "states"
				}
			},
			"transform": [
				{
					"lookup": "properties.Name",
					"from": {
						"data": {
							"url": "https://raw.githubusercontent.com/HXianH/Homework-W10/refs/heads/main/pivoted_dataset.csv",
							"format": {
								"type": "csv"
							}
						},
						"key": "state",
						"fields": [
							"2019", "2020", "2021", "2022", "2023", "2024"
						]
					}
				},
				{
					"calculate": "datum[year_selected] == null ? null : (toNumber(datum[year_selected]) / 10000)",
					"as": "donations_num"
				},
				{
					"calculate": "datum[year_selected] == null ? null : datum[year_selected]",
					"as": "actual_num"
				},
				{
					"calculate": "datum[year_selected] == null ? null : year_selected",
					"as": "year_selected"
				}
			],
			"selection": {
				"hover": {
					"type": "single",
					"on": "mouseover",
					"empty": "all",
					"fields": ["properties.Name"]
				}
			},
			"mark": {
				"type": "geoshape",
				"stroke": "black"
			},
			"encoding": {
				"color": {
					"field": "donations_num",
					"type": "quantitative",
					"title": "Blood Donations",
                    "scale": {
						"scheme": "reds",
						"type": "threshold",
						"domain": [1.3, 1.5, 1.7, 2, 2.3, 2.5, 2.7, 3, 3.3, 3.5, 3.7, 4, 4.1, 4.2, 4.5, 14],
						"range": ["#ffebee", "#ffcdd2", "#ffb3b3", "#ff9999", "#ff8080", "#ff6666", "#ff4d4d", "#ff3333", "#ff1a1a", "#ff0000",
								"#e60000", "#cc0000", "#b30000", "#990000", "#800000", "#660000", "#4d0000", "#330000", "#ff5c5c", "#ff4a4a",
								"#ff3232", "#ff1e1e", "#ff0a0a", "#e61e1e", "#cc1a1a", "#b31212", "#990909"]
        			}
				},
				"opacity": {
					"condition": {"selection": "hover", "value": 1},
					"value": 0.2
				},
				"tooltip": [
					{
						"field": "year_selected",
						"type": "quantitative",
						"title": "Year"
					},
					{
						"field": "properties.Name",
						"type": "nominal",
						"title": "State"
					},
					{
						"field": "actual_num",
						"type": "quantitative",
						"title": "Donations"
					},
					{
						"field": "donations_num",
						"type": "quantitative",
						"title": "Donations per 10,000 people",
						"format": ".2f"
					}
				]
			}
		},
		{
		"mark": {
			"type": "text"
		},
		"encoding": {
			"x": {"value": 490},
			"y": {"value": 380},
			"text": {"value": ""}
		}
		}
	]
}